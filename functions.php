<?php

 	/*require_once( get_stylesheet_directory_uri(() . '/template-blog.php' );
    require_once( get_stylesheet_directory() . '/archive.php' );*/


    /*######################################################################################################
    ########################################################################################################
    ########################################################################################################
    ########################################################################################################
    ############################ Include the parent theme to load ##########################################
    ########################################################################################################
    ########################################################################################################
    ########################################################################################################
    ########################################################################################################*/

    function my_theme_enqueue_styles() {

        $parent_style = 'storefront-style'; // This is 'twentyfifteen-style' for the Twenty Fifteen theme.

        wp_enqueue_style( $parent_style, get_template_directory_uri() . '/style.css' );
        
        wp_enqueue_style( 'child-style',
            get_stylesheet_directory_uri() . '/style.css',
            array( $parent_style ),
            wp_get_theme()->get('Version')
        );
    }

    add_action( 'wp_enqueue_scripts', 'my_theme_enqueue_styles' );

	/*######################################################################################################
    ########################################################################################################
    ########################################################################################################
    ########################################################################################################
    ############################ Hide WP version strings from scripts and styles ###########################
    ########################################################################################################
    ########################################################################################################
    ########################################################################################################
    ########################################################################################################*/    

    function debug_to_console( $data ) 
    {
	    $output = $data;
	    if ( is_array( $output ) )
	        $output = implode( ',', $output);

	    echo "<script>console.log( 'Debug Objects: " . $output . "' );</script>";
	}

	add_action( 'wp_enqueue_scripts', 'debug_to_console' );

   /*######################################################################################################
    ########################################################################################################
    ########################################################################################################
    ########################################################################################################
    ############################ Hide WP version strings from scripts and styles ###########################
    ########################################################################################################
    ########################################################################################################
    ########################################################################################################
    ########################################################################################################*/

    function fjarrett_remove_wp_version_strings( $src ) 
    {
         global $wp_version;
         parse_str(parse_url($src, PHP_URL_QUERY), $query);
         if ( !empty($query['ver']) && $query['ver'] === $wp_version ) 
         {
              $src = remove_query_arg('ver', $src);
         }

         return $src;
    }

    add_filter( 'script_loader_src', 'fjarrett_remove_wp_version_strings' );

    add_filter( 'style_loader_src', 'fjarrett_remove_wp_version_strings' );

    /* Hide WP version strings from generator meta tag */

    function wpmudev_remove_version() 
    {
        return '';
    }

    add_filter('the_generator', 'wpmudev_remove_version');

    /*######################################################################################################
    ########################################################################################################
    ########################################################################################################
    ########################################################################################################
    ####################################### Custom favicon #################################################
    ########################################################################################################
    ########################################################################################################
    ########################################################################################################
    ########################################################################################################*/

    function childtheme_favicon() 
    { ?>
        <link rel="shortcut icon" href="<?php echo get_stylesheet_directory_uri() ?>/img/favicon.ico">
    <?php }
     
    add_action('wp_head', 'childtheme_favicon');

    /*######################################################################################################
	########################################################################################################
	########################################################################################################
	########################################################################################################
	############################### Dynamic copyright tag ##################################################
	########################################################################################################
	########################################################################################################
	########################################################################################################
	########################################################################################################*/

	function comicpress_copyright() 
	{
		global $wpdb;
		$copyright_dates = $wpdb->get_results("
			SELECT
			YEAR(min(post_date_gmt)) AS firstdate,
			YEAR(max(post_date_gmt)) AS lastdate
			FROM
			$wpdb->posts
			WHERE
			post_status = 'publish'
		");
		$output = '';
		if($copyright_dates) 
		{
			$copyright = "&copy; " . $copyright_dates[0]->firstdate;
			if($copyright_dates[0]->firstdate != $copyright_dates[0]->lastdate) 
			{
			$copyright .= '-' . $copyright_dates[0]->lastdate;
			}
			$output = $copyright;
		}
		return $output;
	}

	/*######################################################################################################
	########################################################################################################
	########################################################################################################
	########################################################################################################
	############################### Enable SVG Upload ######################################################
	########################################################################################################
	########################################################################################################
	########################################################################################################
	########################################################################################################*/

	function cc_mime_types($mimes) 
	{
		$mimes['svg'] = 'image/svg+xml';
		
		return $mimes;
	}

	/*######################################################################################################
	########################################################################################################
	########################################################################################################
	########################################################################################################
	############################### Google Merchant feed - Live ############################################
	########################################################################################################
	########################################################################################################
	########################################################################################################
	########################################################################################################*/

	add_action('init', 'initWoocommerceGoogleMerchantFeed');
	
	function initWoocommerceGoogleMerchantFeed()
	{
        add_feed('woocommerce-google-merchant-feed', 'woocommerceGoogleMerchantFeedFuncion');
	}

	function woocommerceGoogleMerchantFeedFuncion()
	{
        get_template_part('rss', 'woocommerce-google-merchant-feed');
	}

		/*######################################################################################################
	########################################################################################################
	########################################################################################################
	########################################################################################################
	############################### Google Merchant feed - Test ############################################
	########################################################################################################
	########################################################################################################
	########################################################################################################
	########################################################################################################*/

	add_action('init', 'initWoocommerceGoogleMerchantTestFeed');
	
	function initWoocommerceGoogleMerchantTestFeed()
	{
        add_feed('woocommerce-google-merchant-test-feed', 'woocommerceGoogleMerchantTestFeedFuncion');
	}

	function woocommerceGoogleMerchantTestFeedFuncion()
	{
        get_template_part('rss', 'woocommerce-google-merchant-test-feed');
	}

	/*######################################################################################################
	########################################################################################################
	########################################################################################################
	########################################################################################################
	############################### Woocommerce custom fields ##############################################
	########################################################################################################
	########################################################################################################
	########################################################################################################
	########################################################################################################*/

	// Display Fields
	add_action( 'woocommerce_product_options_general_product_data', 'woo_add_custom_general_fields' );

	// Save Fields
	add_action( 'woocommerce_process_product_meta', 'woo_add_custom_general_fields_save' );

	function woo_add_custom_general_fields() {

		global $woocommerce, $post;

		echo '<div class="options_group">';

		// Custom fields will be created here...

		// Product brand
		woocommerce_wp_text_input( 
			array( 
				'id'          => '_brand', 
				'label'       => __( 'Product brand', 'woocommerce' ), 
				'placeholder' => '',
				'desc_tip'    => 'true',
				'description' => __( 'Enter the product brand here.', 'woocommerce' ) 
			)
		);

		// Product condition
		woocommerce_wp_select( 
		array( 
			'id'      => '_condition', 
			'label'   => __( 'Condition', 'woocommerce' ), 
			'options' => array(
				'new'   => __( 'New', 'woocommerce' ),
				'refurbished'   => __( 'Refurbished', 'woocommerce' ),
				'used' => __( 'Used', 'woocommerce' )
				)
			)
		);

		echo '</div>';
		
	}

	function woo_add_custom_general_fields_save( $post_id ) {
	
		// Text Field
		$woocommerce_text_field = $_POST['_brand'];
		
		if( !empty( $woocommerce_text_field ) )
			update_post_meta( $post_id, '_brand', esc_attr( $woocommerce_text_field ) );

		// Select
		$woocommerce_select = $_POST['_condition'];
		if( !empty( $woocommerce_select ) )
			update_post_meta( $post_id, '_condition', esc_attr( $woocommerce_select ) );

	}

	/*######################################################################################################
	########################################################################################################
	########################################################################################################
	########################################################################################################
	############################### Post pagination ########################################################
	########################################################################################################
	########################################################################################################
	########################################################################################################
	########################################################################################################*/

	/*function archivePaginate() 
	{
		global $wp_query, $wp_rewrite;
		$wp_query->query_vars['paged'] > 1 ? $current = $wp_query->query_vars['paged'] : $current = 1;
		
		$pagination = array(
			'base' => @add_query_arg('page','%#%'),
			'format' => '',
			'total' => $wp_query->max_num_pages,
			'current' => $current,
			'show_all' => true,
			'type' => 'list',
			'next_text' => '&raquo;',
			'prev_text' => '&laquo;'
			);
		
		if( $wp_rewrite->using_permalinks() )
			$pagination['base'] = user_trailingslashit( trailingslashit( remove_query_arg( 's', get_pagenum_link( 1 ) ) ) . 'page/%#%/', 'paged' );
		
		if( !empty($wp_query->query_vars['s']) )
			$pagination['add_args'] = array( 's' => get_query_var( 's' ) );
		
		echo paginate_links( $pagination );
	}*/

	/*######################################################################################################
	########################################################################################################
	########################################################################################################
	############################### Load more posts - Enqueue jQuery and  ##################################
	############################### myloadmore.js. Pass query parameters  ##################################
	############################### to the script                         ##################################
	########################################################################################################
	########################################################################################################
	########################################################################################################*/

	function wordpress_my_load_more_scripts() 
	{
		global $wp_query; 

		// In most cases it is already included on the page and this line can be removed
		wp_enqueue_script('jquery');
	 
		// register our main script but do not enqueue it yet
		wp_register_script( 'my_loadmore', get_stylesheet_directory_uri() . '/myloadmore.js', array('jquery') );
	 
		// now the most interesting part
		// we have to pass parameters to myloadmore.js script but we can get the parameters values only in PHP
		// you can define variables directly in your HTML but I decided that the most proper way is wp_localize_script()
		wp_localize_script( 'my_loadmore', 'wordpress_loadmore_params', array(
			//'ajaxurl' => admin_url() . 'admin-ajax.php', // WordPress AJAX
			//'ajaxurl' => admin_url( 'admin-ajax.php'), 
			'ajaxurl' => admin_url( 'admin-ajax.php' ),
			'posts' => json_encode( $wp_query->query_vars ), // everything about your loop is here
			'current_page' => get_query_var( 'paged' ) ? get_query_var('paged') : 1,
			//'max_page' => '3',
			'max_page' => json_encode( $wp_query->max_num_pages)
		));
	 
	 	wp_enqueue_script( 'my_loadmore' );

	}
	 
	add_action( 'wp_enqueue_scripts', 'wordpress_my_load_more_scripts' );

	
	/*######################################################################################################
	########################################################################################################
	########################################################################################################
	########################################################################################################
	############################### AJAX handler ###########################################################
	########################################################################################################
	########################################################################################################
	########################################################################################################
	########################################################################################################*/

	function wordpress_loadmore_ajax_handler()
	{
		debug_to_console("Hello!");

		// prepare our arguments for the query
		$args = json_decode( stripslashes( $_POST['query'] ), true );
		$args['paged'] = $_POST['page'] + 1; // we need next page to be loaded
		$args['post_status'] = 'publish';


		// it is always better to use WP_Query but not here
		query_posts( $args );
		//$re_query = new WP_Query($args);
	 
		if(have_posts() ) :

			echo "We have post(s)!";
	
			// run the loop
			while( have_posts() ): the_post();
	 
				echo "A post!";
				// look into your theme code how the posts are inserted, but you can use your own HTML of course
				// do you remember? - my example is adapted for Twenty Seventeen theme
				//get_template_part( 'blog', 'standard' );
				// for the test purposes comment the line above and uncomment the below one
				// the_title();
	 
	 
			endwhile;
	 
		endif;

		debug_to_console("Die!");

		die; // here we exit the script and even no wp_reset_query() required!
	} 
	 
	add_action('wp_ajax_loadmore', 'wordpress_loadmore_ajax_handler'); // wp_ajax_{action}
	add_action('wp_ajax_nopriv_loadmore', 'wordpress_loadmore_ajax_handler'); // wp_ajax_nopriv_{action}

?>